name: Minder Apply IaC repo

on:
  push:
    branches:
    - main

permissions:
  id-token: write
  contents: read

jobs:
  apply-iac:
    runs-on: ubuntu-latest
    name: Apply Minder Policies And RuleTypes
    steps:
      - name: Fetch ID token
        run: |
          set -x -e
          echo $GITHUB_TOKEN
          URL="${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=minder"
          curl -o .action-token -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" $URL
          echo "MINDER_AUTH_TOKEN=$(jq -r .value <.action-token)" >> "$GITHUB_ENV"
      - name: Install cosign to verify Minder
        uses: sigstore/cosign-installer@4959ce089c160fddf62f7b42464195ba1a56d382 # v3.6.0
      - name: Install Minder Client
        uses: stacklok/minder-client-installer@0d4c5ed9a8dc6a2d152beeaf7b9cfb1fb5556dca # main
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4
      - name: Apply Minder ruletypes
        env:
          MINDER_PROJECT: d718c263-debf-4960-b00c-e41c54c3658e
          # Very temporary!  My ngrok endpoint
          MINDER_GRPC_SERVER_PORT: 12004
          MINDER_GRPC_SERVER_HOST: 0.tcp.us-cal-1.ngrok.io
          MINDER_GRPC_SERVER_INSECURE: true
        run: |
          minder ruletype apply -f ./rule-types
          # Minder ruletype apply takes a directory, but profile apply does not!!
          minder profile apply -f ./profiles/enable-auto-apply.yaml
